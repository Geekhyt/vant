import{c as U,e as P,F as $,i as ue,u as se,n as Z,l as ee,b as re,G as me,H as q,p as z}from"./use-translate.8036e41d.js";import{n as V,d as S,b as F,c as I,t as de,m as fe}from"./with-install.6887218d.js";import{H as G,a as ve}from"./constant.80c6de18.js";import{u as te}from"./use-expose.1f17c8d6.js";import{L as he}from"./index.e68b0dfb.js";import{u as ge}from"./use-touch.ee9512d6.js";import{A as Y,x as C,R as be,e as r,D as p,y as _,B as Oe}from"./vue-libs.a040eeb8.js";const[Te,b,J]=U("picker"),ne=e=>e.find(a=>!a.disabled)||e[0];function ye(e,a){const o=e[0];if(o){if(Array.isArray(o))return"multiple";if(a.children in o)return"cascade"}return"default"}function R(e,a){a=$(a,0,e.length);for(let o=a;o<e.length;o++)if(!e[o].disabled)return o;for(let o=a-1;o>=0;o--)if(!e[o].disabled)return o;return 0}const Q=(e,a,o)=>a!==void 0&&!!e.find(u=>u[o.value]===a);function L(e,a,o){const u=e.findIndex(m=>m[o.value]===a),l=R(e,u);return e[l]}function pe(e,a,o){const u=[];let l={[a.children]:e},m=0;for(;l&&l[a.children];){const d=l[a.children],c=o.value[m];if(l=ue(c)?L(d,c,a):void 0,!l&&d.length){const f=ne(d)[a.value];l=L(d,f,a)}m++,u.push(d)}return u}function Ce(e){const{transform:a}=window.getComputedStyle(e),o=a.slice(7,a.length-1).split(", ")[5];return Number(o)}function ke(e){return P({text:"text",value:"value",children:"children"},e)}const W=200,X=300,xe=15,[oe,A]=U("picker-column"),ae=Symbol(oe),we=Y({name:oe,props:{value:V,fields:S(Object),options:F(),readonly:Boolean,allowHtml:Boolean,optionHeight:S(Number),swipeDuration:S(V),visibleOptionNum:S(V)},emits:["change","clickOption"],setup(e,{emit:a,slots:o}){let u,l,m,d,c;const f=C(),k=C(),s=C(0),h=C(0),O=ge(),y=()=>e.options.length,T=()=>e.optionHeight*(+e.visibleOptionNum-1)/2,x=t=>{const n=R(e.options,t),i=-n*e.optionHeight,v=()=>{const g=e.options[n][e.fields.value];g!==e.value&&a("change",g)};u&&i!==s.value?c=v:v(),s.value=i},D=t=>{u||e.readonly||(c=null,h.value=W,x(t),a("clickOption",e.options[t]))},w=t=>$(Math.round(-t/e.optionHeight),0,y()-1),M=(t,n)=>{const i=Math.abs(t/n);t=s.value+i/.003*(t<0?-1:1);const v=w(t);h.value=+e.swipeDuration,x(v)},H=()=>{u=!1,h.value=0,c&&(c(),c=null)},N=t=>{if(!e.readonly){if(O.start(t),u){const n=Ce(k.value);s.value=Math.min(0,n-T())}h.value=0,l=s.value,m=Date.now(),d=l,c=null}},B=t=>{if(e.readonly)return;O.move(t),O.isVertical()&&(u=!0,ee(t,!0)),s.value=$(l+O.deltaY.value,-(y()*e.optionHeight),e.optionHeight);const n=Date.now();n-m>X&&(m=n,d=s.value)},E=()=>{if(e.readonly)return;const t=s.value-d,n=Date.now()-m;if(n<X&&Math.abs(t)>xe){M(t,n);return}const v=w(s.value);h.value=W,x(v),setTimeout(()=>{u=!1},0)},j=()=>{const t={height:`${e.optionHeight}px`};return e.options.map((n,i)=>{const v=n[e.fields.text],{disabled:g}=n,le=n[e.fields.value],ie={role:"button",style:t,tabindex:g?-1:0,class:[A("item",{disabled:g,selected:le===e.value}),n.className],onClick:()=>D(i)},ce={class:"van-ellipsis",[e.allowHtml?"innerHTML":"textContent"]:v};return r("li",ie,[o.option?o.option(n):r("div",ce,null)])})};return se(ae),te({stopMomentum:H}),be(()=>{const t=e.options.findIndex(v=>v[e.fields.value]===e.value),i=-R(e.options,t)*e.optionHeight;s.value=i}),Z("touchmove",B,{target:f}),()=>r("div",{ref:f,class:A(),onTouchstartPassive:N,onTouchend:E,onTouchcancel:E},[r("ul",{ref:k,style:{transform:`translate3d(0, ${s.value+T()}px, 0)`,transitionDuration:`${h.value}ms`,transitionProperty:h.value?"all":"none"},class:A("wrapper"),onTransitionend:H},[j()])])}}),[Ee]=U("picker-toolbar"),K={title:String,cancelButtonText:String,confirmButtonText:String},Pe=["cancel","confirm","title","toolbar"],He=Object.keys(K),Se=Y({name:Ee,props:K,emits:["confirm","cancel"],setup(e,{emit:a,slots:o}){const u=()=>{if(o.title)return o.title();if(e.title)return r("div",{class:[b("title"),"van-ellipsis"]},[e.title])},l=()=>a("cancel"),m=()=>a("confirm"),d=()=>{const f=e.cancelButtonText||J("cancel");return r("button",{type:"button",class:[b("cancel"),G],onClick:l},[o.cancel?o.cancel():f])},c=()=>{const f=e.confirmButtonText||J("confirm");return r("button",{type:"button",class:[b("confirm"),G],onClick:m},[o.confirm?o.confirm():f])};return()=>r("div",{class:b("toolbar")},[o.toolbar?o.toolbar():[d(),u(),c()]])}}),De=P({loading:Boolean,readonly:Boolean,allowHtml:Boolean,optionHeight:I(44),showToolbar:de,swipeDuration:I(1e3),visibleOptionNum:I(6)},K),Me=P({},De,{columns:F(),modelValue:F(),toolbarPosition:fe("top"),columnsFieldNames:Object}),Fe=Y({name:Te,props:Me,emits:["confirm","cancel","change","clickOption","update:modelValue"],setup(e,{emit:a,slots:o}){const u=C(),l=C(e.modelValue),{children:m,linkChildren:d}=re(ae);d();const c=p(()=>ke(e.columnsFieldNames)),f=p(()=>me(e.optionHeight)),k=p(()=>ye(e.columns,c.value)),s=p(()=>{const{columns:t}=e;switch(k.value){case"multiple":return t;case"cascade":return pe(t,c.value,l);default:return[t]}}),h=p(()=>s.value.some(t=>t.length)),O=p(()=>s.value.map((t,n)=>L(t,l.value[n],c.value))),y=(t,n)=>{if(l.value[t]!==n){const i=l.value.slice(0);i[t]=n,l.value=i}},T=()=>({selectedValues:l.value,selectedOptions:O.value}),x=(t,n)=>{y(n,t),k.value==="cascade"&&l.value.forEach((i,v)=>{const g=s.value[v];Q(g,i,c.value)||y(v,g.length?g[0][c.value.value]:void 0)}),a("change",P({columnIndex:n},T()))},D=(t,n)=>a("clickOption",P({columnIndex:n,currentOption:t},T())),w=()=>{m.forEach(t=>t.stopMomentum()),a("confirm",T())},M=()=>a("cancel",T()),H=()=>s.value.map((t,n)=>r(we,{value:l.value[n],fields:c.value,options:t,readonly:e.readonly,allowHtml:e.allowHtml,optionHeight:f.value,swipeDuration:e.swipeDuration,visibleOptionNum:e.visibleOptionNum,onChange:i=>x(i,n),onClickOption:i=>D(i,n)},{option:o.option})),N=t=>{if(h.value){const n={height:`${f.value}px`},i={backgroundSize:`100% ${(t-f.value)/2}px`};return[r("div",{class:b("mask"),style:i},null),r("div",{class:[ve,b("frame")],style:n},null)]}},B=()=>{const t=f.value*+e.visibleOptionNum,n={height:`${t}px`};return r("div",{ref:u,class:b("columns"),style:n},[H(),N(t)])},E=()=>{if(e.showToolbar)return r(Se,Oe(z(e,He),{onConfirm:w,onCancel:M}),z(o,Pe))};return _(s,t=>{t.forEach((n,i)=>{n.length&&!Q(n,l.value[i],c.value)&&y(i,ne(n)[c.value.value])})},{immediate:!0}),_(()=>e.modelValue,t=>{q(t,l.value)||(l.value=t)},{deep:!0}),_(l,t=>{q(t,e.modelValue)||a("update:modelValue",t)},{immediate:!0}),Z("touchmove",ee,{target:u}),te({confirm:w,getSelectedOptions:()=>O.value}),()=>{var t,n;return r("div",{class:b()},[e.toolbarPosition==="top"?E():null,e.loading?r(he,{class:b("loading")},null):null,(t=o["columns-top"])==null?void 0:t.call(o),B(),(n=o["columns-bottom"])==null?void 0:n.call(o),e.toolbarPosition==="bottom"?E():null])}}});export{Fe as _,De as p};
